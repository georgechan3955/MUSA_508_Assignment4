---
title: "HW4"
author: "Xiayuanshan Gao"
date: "2024-04-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=10000000)
library(RSocrata)
library(tidyverse)
library(kableExtra)
library(caret)
library(knitr) 
library(pscl)
library(plotROC)
library(pROC)
library(lubridate)
library(ggplot2)

palette5 <- c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c")
palette4 <- c("#D2FBD4","#92BCAB","#527D82","#123F5A")
palette2 <- c("#6baed6","#08519c")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
recidivism <- 
  read.socrata("https://data.ojp.usdoj.gov/Courts/NIJ-s-Recidivism-Challenge-Full-Dataset/ynf5-u8nk")
recidivism <- recidivism %>%
   mutate(recidivism_within_3years_numreic = case_when(
    recidivism_within_3years == "true" ~ 1,
    recidivism_within_3years == "false" ~ 0,
    TRUE ~ NA_integer_  # Handles any unexpected values
  ))

recidivism <- recidivism %>%
  drop_na(gender, race, age_at_release, supervision_level_first, education_level,
                   prison_offense, prison_years, violations, residence_puma,
                   supervision_risk_score_first, percent_days_employed, jobs_per_year,
                   avg_days_per_drugtest, drugtests_thc_positive, drugtests_meth_positive,
                   drugtests_cocaine_positive)

```



## Categorical Variables

```{r cache = TRUE, warning = FALSE, message = FALSE,fig.width=10, fig.height=10}
# Assuming 'recidivism' is your dataframe and 'palette2' is defined with appropriate colors
cat_var <- recidivism %>% 
  select(recidivism_within_3years, gender, race, age_at_release, supervision_level_first, education_level, prison_offense, prison_years, violations) %>%
  gather(Variable, value, -recidivism_within_3years) %>%
  count(Variable, value, recidivism_within_3years) %>%
    ggplot(aes(Variable, n, fill = recidivism_within_3years)) +
      geom_bar(position = "dodge", stat = "identity") + 
      facet_wrap(~Variable, scales = "free", ncol = 4, labeller = labeller(Variable = c(
                     gender = "Gender",
                     race = "Race",
                     age_at_release = "Age at Release",
                     supervision_level_first = "Supervision Level First",
                     education_level = "Education Level",
                     prison_offense = "Prison Offense",
                     prison_years = "Years in Prison",
                     violations = "Violations"))) +
      scale_fill_manual(values = palette2, name="recidivism_within_3years") +
      labs(x="recidivism_within_3years", y="Count", 
           title = "Feature Associations with the Likelihood of Recidivism",
           subtitle = "Categorical features") +
      theme(
            legend.position = "none",
            axis.text.x = element_text(angle = 45, hjust = 1, size = 10), # Consolidated text.x settings
            plot.subtitle = element_text(size = 12, face = "italic"),
            plot.title = element_text(size = 18, face = "bold"), 
            axis.text.y = element_text(size = 10), 
            axis.title = element_text(size = 9), 
            panel.background = element_blank(),
            panel.border = element_rect(colour = "grey", fill = NA, linewidth = 0.8))
```








```{r cache = TRUE, warning = FALSE, message = FALSE}
cat_var <- recidivism %>%
  select(recidivism_within_3years, gender, race, age_at_release, supervision_level_first, education_level, prison_offense, prison_years, violations) %>%
  pivot_longer(cols = -recidivism_within_3years, names_to = "Variable", values_to = "value") %>%
  group_by(Variable, value, recidivism_within_3years) %>%
  summarise(mean_value = mean(recidivism_within_3years, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = value, y = mean_value, fill = as.factor(recidivism_within_3years))) + 
    geom_col(position = "dodge") + 
    facet_wrap(~Variable, scales = "free",ncol = 4) +
    scale_fill_manual(values = palette2, name="Recidivism_within_3years") +
    labs(x = "Category", y = "Mean", 
         title = "Feature associations with the likelihood of Recidivism within 3 years",
         subtitle = "Categorical outcomes") +
    theme(
          plot.subtitle = element_text(size = 12,face = "italic"),
          plot.title = element_text(size = 18, face = "bold"), 
          axis.text.x = element_text(angle = 45, vjust = 1),
          axis.text.y = element_text(size = 8), 
          axis.title = element_text(size = 9), 
          panel.background = element_blank(),
          panel.border = element_rect(colour = "grey", fill = NA, linewidth = 0.8))

```

## Chi square
```{r cache = TRUE, warning = FALSE, message = FALSE,fig.width=10, fig.height=10}
chi_var <- c("gender","race", "age_at_release", "education_level","prison_years","violations")


chi_square_results <- data.frame(
  Df = integer(),
  X_Squared = numeric(),
  P_Value = numeric(),
  stringsAsFactors = FALSE
)

for (var in chi_var) {
  contingency_table <- table(cat_var$recidivism_within_3years_numeric, cat_var[[var]])
  chi_square <- chisq.test(contingency_table)
  chi_square_results <- rbind(chi_square_results, data.frame(
    Df = chi_square$parameter,
    X_Squared = chi_square$statistic,
    P_Value = chi_square$p.value
  ))
}

rownames(chi_square_results) <- Label


chi_square_results %>% 
 kable() %>% 
 kable_styling( bootstrap_options = c("striped", "hover", "condensed")) %>% 
    footnote(general_title = "\n", general = "Table 1")
```

## Numeric Variables
```{r cache = TRUE, warning = FALSE, message = FALSE,fig.width=10, fig.height=10}
numeric_var <- recidivism %>% 
  select(recidivism_within_3years, residence_puma,supervision_risk_score_first, percent_days_employed, jobs_per_year, avg_days_per_drugtest, drugtests_thc_positive, drugtests_meth_positive,drugtests_cocaine_positive)


numeric_var %>%
  gather(Variable, value, -recidivism_within_3years) %>%
    ggplot(aes(recidivism_within_3years, value, fill=recidivism_within_3years)) + 
      geom_bar(position = "dodge", stat = "summary", fun = "mean") + 
      facet_wrap(~Variable, scales = "free", ncol = 4, labeller= labeller(Variable = c(
                     `residence_puma` = "Residence PUMA",
                     `supervision_risk_score_first` = "Supervision Risk Score",
                     `percent_days_employed` = "Percent Days Employed",
                     `jobs_per_year` = "Jobs Per Year",
                     `avg_days_per_drugtest` = "Avg Days Per Drugtest",
                     `drugtests_thc_positive` = "Drugtests_THC_Positive",
                     `drugtests_meth_positive` = "Drugtests_Meth_Positive",
                     `drugtests_cocaine_positive`= "Drugtests_Cocaine_Positive"))) +
      scale_fill_manual(values = palette2) +
      labs(x="Recidivism_within_3years", y="Value", 
           title = "Feature Associations with the Likelihood of Recidivism",
           subtitle = "Numeric features") +
      theme(legend.position = "none") +
    theme(plot.subtitle = element_text(size = 12,face = "italic"),
        plot.title = element_text(size = 18, face = "bold"), 
        axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10), 
        axis.title=element_text(size=9), 
        panel.background = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA, linewidth =0.8))
```





```{r cache = TRUE, warning = FALSE, message = FALSE, fig.height=10}
numeric_var %>%
    gather(Variable, value, -recidivism_within_3years) %>%
    ggplot() + 
    geom_density(aes(value, color=recidivism_within_3years), fill = "transparent") + 
   facet_wrap(~Variable, scales = "free", ncol = 4, labeller= labeller(Variable = c(
                     `residence_puma` = "Residence PUMA",
                     `supervision_risk_score_first` = "Supervision Risk Score",
                     `percent_days_employed` = "Percent Days Employed",
                     `jobs_per_year` = "Jobs Per Year",
                     `avg_days_per_drugtest` = "Avg Days Per Drugtest",
                     `drugtests_thc_positive` = "Drugtests_THC_Positive",
                     `drugtests_meth_positive` = "Drugtests_Meth_Positive",
                     `drugtests_cocaine_positive`= "Drugtests_Cocaine_Positive"))) +
  scale_color_manual(values = palette2) +
    labs(title = "Feature Distributions Based on Recidivism",
         subtitle = "Continous features") +
  theme(plot.subtitle = element_text(size = 12,face = "italic"),
        plot.title = element_text(size = 18, face = "bold"), 
        axis.text.x=element_text(size=9),
        axis.text.y=element_text(size=9), 
        axis.title=element_text(size=9), 
        panel.background = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA, linewidth =0.8))
```



```{r}
anova_var <- c(recidivism_within_3years, residence_puma,supervision_risk_score_first, percent_days_employed, jobs_per_year, avg_days_per_drugtest, drugtests_thc_positive, drugtests_meth_positive,drugtests_cocaine_positive)

new_names <- c("residence_puma" = "Residence PUMA",
                     "supervision_risk_score_first"= "Supervision Risk Score",
                     "percent_days_employed" = "Percent Days Employed",
                     "jobs_per_year"= "Jobs Per Year",
                     "avg_days_per_drugtest" = "Avg Days Per Drugtest",
                     "drugtests_thc_positive" = "Drugtests_THC_Positive",
                     "drugtests_meth_positive" = "Drugtests_Meth_Positive",
                     "drugtests_cocaine_positive"= "Drugtests_Cocaine_Positive")

anova_results <- data.frame(
                            Df = integer(), 
                            Sum_Sq = numeric(), 
                            Mean_Sq = numeric(), 
                            F_value = numeric(), 
                            P_Value = numeric(), stringsAsFactors = FALSE)

for (var in anova_var) {
  anova_result <- aov(numeric_var[[var]] ~ numeric_var$y)
  summary_data <- summary(anova_result)[[1]][, c("Df", "Sum Sq", "Mean Sq", "F value", "Pr(>F)")][1:1, ]
  anova_results <- rbind(anova_results, summary_data)
}


rownames(anova_results) <- new_names


anova_results %>% 
 kable() %>% 
 kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
    footnote(general_title = "\n", general = "Table 2")
```


## Feature Engineering
```{r cache = TRUE, warning = FALSE, message = FALSE,fig.width=10, fig.height=10}
# age
recidivism <-recidivism %>%
  mutate(age = case_when(
    age_at_release == "18-22"  ~ "Gen Z",
    age_at_release =="38-42" |age_at_release == "43-47" |age_at_release == "48 or older"  ~ "Gen X",
    age_at_release == "23-27" |age_at_release == "28-32" |age_at_release == "33-37" ~ "Millenials"))

recidivism <-recidivism %>%
  mutate(jobnumber = cut(jobs_per_year,
                        breaks = c(-Inf, 1, 5, Inf),  # Define intervals, including all numbers
                        labels = c("0-1", "2-5", "6-8"),  # Labels for each interval
                        include.lowest = TRUE) )

recidivism <-recidivism %>%
  mutate(employmentstates = cut(percent_days_employed,
                        breaks = c(-Inf, 0, 0.99, Inf),  # Define intervals, including all numbers
                        labels = c("Unemployed", "Parttime emplyed", "Employed"),  # Labels for each interval
                        include.lowest = TRUE) )

```






## Logistic Regression
```{r}
set.seed(479)
trainIndex <- createDataPartition(y = paste(recidivism$residence_puma) , p = .65,
                                  list = FALSE,
                                  times = 1)
```


```{r}
recidivismTrain <- recidivism[ trainIndex,]
recidivismTest  <- recidivism[-trainIndex,]

recidivismModel <- glm(recidivism_within_3years_numreic ~ .,
                  data=recidivismTrain %>% 
                    dplyr::select(recidivism_within_3years_numreic,gender,race,age,dependents, supervision_level_first,education_level,prison_years,violations,residence_puma,supervision_risk_score_first, percent_days_employed,jobs_per_year,drugtests_thc_positive, drugtests_meth_positive,gang_affiliated), family="binomial" (link="logit"))

recidivism_sum <- summary(recidivismModel)
coefficients_table <- as.data.frame(recidivism_sum$coefficients)

coefficients_table$significance <- ifelse(coefficients_table$`Pr(>|z|)` < 0.001, '***',
                                         ifelse(coefficients_table$`Pr(>|z|)` < 0.01, '**',
                                                ifelse(coefficients_table$`Pr(>|z|)` < 0.05, '*',
                                                       ifelse(coefficients_table$`Pr(>|z|)` < 0.1, '.', ''))))

coefficients_table$p_value <- paste0(round(coefficients_table$`Pr(>|z|)`, digits = 3), coefficients_table$significance)

coefficients_table %>%
  select(-significance, -`Pr(>|z|)`) %>% 
  kable(align = "r") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  footnote(general_title = "\n", general = "Table 3")
```

```{r}
pR2(recidivismModel) #McFadden: 0.246
```
```{r}
testProbs <- data.frame(Outcome = as.factor(recidivismTest$recidivism_within_3years_numreic), Probs = predict(recidivismModel, recidivismTest, type= "response"))
head(testProbs)
```
```{r}
ggplot(testProbs, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density() +
  facet_grid(Outcome ~ .) +
  scale_fill_manual(values = palette2) + xlim(0, 1) +
  labs(x = "Recidivism", y = "Density of probabilities",
       title = "Distribution of predicted probabilities by observed outcome") + theme(strip.text.x = element_text(size = 18),
        legend.position = "none")
```
## Logistic Regression
```{r}
ggplot(testProbs, aes(d = as.numeric(testProbs$Outcome), m = Probs)) +
  geom_roc(n.cuts = 50, labels = FALSE, colour = "#FE9900") +
  style_roc(theme = theme_grey) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = 'grey') +
  labs(title = "Figure 5: ROC Curve - Recidivism")
```

```{r}
pROC::auc(testProbs$Outcome, testProbs$Probs) # AUC: .73
```

```{r}
testProbs <- 
  testProbs %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs$Probs > 0.5 , 1, 0)))
caret::confusionMatrix(testProbs$predOutcome, testProbs$Outcome, 
                       positive = "1")
```