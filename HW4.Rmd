---
title: "HW4"
author: "Xiayuanshan Gao"
date: "2024-04-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=10000000)
library(RSocrata)
library(tidyverse)
library(kableExtra)
library(caret)
library(knitr) 
library(pscl)
library(plotROC)
library(pROC)
library(lubridate)
library(ggplot2)

palette5 <- c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c")
palette4 <- c("#D2FBD4","#92BCAB","#527D82","#123F5A")
palette2 <- c("#6baed6","#08519c")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
recidivism <- 
  read.socrata("https://data.ojp.usdoj.gov/Courts/NIJ-s-Recidivism-Challenge-Full-Dataset/ynf5-u8nk")
recidivism <- recidivism %>%
   mutate(recidivism_within_3years_numreic = case_when(
    recidivism_within_3years == "true" ~ 1,
    recidivism_within_3years == "false" ~ 0,
    TRUE ~ NA_integer_  # Handles any unexpected values
  ))


recidivism <- recidivism %>%
  drop_na(gender, race, age_at_release, supervision_level_first, education_level,
                   prison_offense, prison_years, violations, residence_puma,
                   supervision_risk_score_first, percent_days_employed, jobs_per_year,
                   avg_days_per_drugtest, drugtests_thc_positive, drugtests_meth_positive,
                   drugtests_cocaine_positive)

```


## Exploratory Analysis - Recidivism


```{r cache = TRUE, warning = FALSE, message = FALSE}
ggplot(data = recidivism) +
  geom_bar(aes(recidivism_within_3years,fill = recidivism_within_3years),width = 0.4) +
          scale_fill_manual(values = palette2,
                          name = 'Recidivism') +
  labs(x="Recidivism", y="Count", 
           title = "Non-recidivism vs.Recidivism\n",
       caption = 'Figure 2.1') +
      theme(legend.position = "none") 
```

## Categorical Variables

```{r cache = TRUE, warning = FALSE, message = FALSE,fig.width=10, fig.height=10}
cat_var <- recidivism %>%
  select(recidivism_within_3years, gender, race, age_at_release, supervision_level_first, education_level, prison_offense, prison_years, violations,prior_arrest_episodes_felony,prior_arrest_episodes_misd,delinquency_reports,residence_changes,prior_conviction_episodes_6,prior_conviction_episodes_5,prior_conviction_episodes_4,prior_conviction_episodes_3,prior_conviction_episodes_2,prior_conviction_episodes_1,prior_conviction_episodes_7) %>%
  pivot_longer(cols = -recidivism_within_3years, names_to = "Variable", values_to = "value") %>%
  count(Variable, value, recidivism_within_3years) %>%
  ggplot(aes(x = value, y = n, fill = recidivism_within_3years)) + 
    geom_bar(stat = "identity", position = "dodge") +
    facet_wrap(~Variable, scales = "free", ncol = 4,
               labeller = labeller(Variable = c(
                 gender = "Gender",
                 race = "Race",
                 age_at_release = "Age at Release",
                 supervision_level_first = "Supervision Level",
                 education_level = "Education Level",
                 prison_offense = "Prison Offense",
                 prison_years = "Years in Prison",
                 violations = "Violations",
                 prior_arrest_episodes_felony = "Prior Arrest Episodes Felony",
                 prior_arrest_episodes_misd = "Prior Arrest Episodes Misd",
                 delinquency_reports="Delinquency Reports",
                 residence_changes = "Residence Changes",
                 prior_conviction_episodes_7 = "Prior Conviction Episodes:Gun Charges",
                 prior_conviction_episodes_6 = "Prior Conviction Episodes:Domestic Violence Charges",
                 prior_conviction_episodes_5 = "Prior Conviction Episodes:Probation Violation Charges",
                 prior_conviction_episodes_4 = "Prior Conviction Episodes:Drug",
                 prior_conviction_episodes_3 = "Prior Conviction Episodes:Property",
                 prior_conviction_episodes_2 = "Prior Conviction Episodes:Violence",
                 prior_conviction_episodes_1 = "Prior Conviction Episodes:Misdemeanor",
                 employment_exempt = "Employment Exempt"))) +
    scale_fill_manual(values = palette2, name = "Recidivism_within_3years") +
    labs(x = "Category", y = "Count",
         title = "Feature Associations with the Likelihood of Recidivism within 3 Years",
         subtitle = "Categorical Outcomes") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8), # Specify once
          plot.subtitle = element_text(size = 12, face = "italic"),
          plot.title = element_text(size = 18, face = "bold"),
          axis.text.y = element_text(size = 8),
          axis.title = element_text(size = 9),
          panel.background = element_blank(),
          panel.border = element_rect(colour = "grey", fill = NA, linewidth = 0.8))

print(cat_var)
```








```{r cache = TRUE, warning = FALSE, message = FALSE}
cat_var <- recidivism %>%
  select(recidivism_within_3years, gender, race, age_at_release, supervision_level_first, education_level, prison_offense, prison_years, violations) %>%
  pivot_longer(cols = -recidivism_within_3years, names_to = "Variable", values_to = "value") %>%
  group_by(Variable, value, recidivism_within_3years) %>%
  summarise(mean_value = mean(recidivism_within_3years, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = value, y = mean_value, fill = as.factor(recidivism_within_3years))) + 
    geom_col(position = "dodge") + 
    facet_wrap(~Variable, scales = "free",ncol = 4) +
    scale_fill_manual(values = palette2, name="Recidivism_within_3years") +
    labs(x = "Category", y = "Mean", 
         title = "Feature associations with the likelihood of Recidivism within 3 years",
         subtitle = "Categorical outcomes") +
    theme(
          plot.subtitle = element_text(size = 12,face = "italic"),
          plot.title = element_text(size = 18, face = "bold"), 
          axis.text.x = element_text(angle = 45, vjust = 1),
          axis.text.y = element_text(size = 8), 
          axis.title = element_text(size = 9), 
          panel.background = element_blank(),
          panel.border = element_rect(colour = "grey", fill = NA, linewidth = 0.8))

```

## Chi square
```{r cache = TRUE, warning = FALSE, message = FALSE,fig.width=10, fig.height=10}
cat_var <- recidivism %>%
  select(recidivism_within_3years, gender, race, age_at_release, supervision_level_first, education_level, prison_offense, prison_years, violations)

chi_var <- c("gender", "race", "age_at_release", "supervision_level_first", "education_level", "prison_offense", "prison_years", "violations")
label_map <- c(gender = "Gender", race = "Race", age_at_release = "Age at Release",
               supervision_level_first = "Supervision Level First", education_level = "Education Level",
               prison_offense = "Prison Offense", prison_years = "Years in Prison", violations = "Violations")

chi_square_results <- data.frame(
  Variable = character(),
  Df = integer(),
  X_Squared = numeric(),
  P_Value = numeric(),
  stringsAsFactors = FALSE
)


for (var in chi_var) {
  contingency_table <- table(cat_var[[var]], cat_var$recidivism_within_3years)
  chi_square_test <- tryCatch({
    chisq.test(contingency_table)
  }, warning = function(w) {
    message("Warning for ", var, ": ", w$message)
    return(NULL)  # Return NULL if there's a warning
  }, error = function(e) {
    message("Error for ", var, ": ", e$message)
    return(NULL)  # Return NULL if there's an error
  })


  if (!is.null(chi_square_test)) {
    chi_square_results <- rbind(chi_square_results, data.frame(
      Variable = label_map[var],
      Df = chi_square_test$parameter,
      X_Squared = chi_square_test$statistic,
      P_Value = chi_square_test$p.value
    ))
  }
}
chi_square_results <- chi_square_results[, -1]

# Use the label_map you created earlier to set the row names to the descriptive labels
rownames(chi_square_results) <- label_map[chi_var]

# Generate the table without the first column of code variable names
kable(chi_square_results, col.names = c("Degrees of Freedom", "Chi-Squared", "P-Value")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  footnote(general_title = "\n", general = "Table 1: Chi-square Test Results for Recidivism Variables")
```

## Numeric Variables
```{r cache = TRUE, warning = FALSE, message = FALSE,fig.width=10, fig.height=10}
numeric_var <- recidivism %>% 
  select(recidivism_within_3years, supervision_risk_score_first, percent_days_employed, jobs_per_year, avg_days_per_drugtest, drugtests_thc_positive, drugtests_meth_positive,drugtests_cocaine_positive)


numeric_var %>%
  gather(Variable, value, -recidivism_within_3years) %>%
    ggplot(aes(recidivism_within_3years, value, fill=recidivism_within_3years)) + 
      geom_bar(position = "dodge", stat = "summary", fun = "mean") + 
      facet_wrap(~Variable, scales = "free", ncol = 4, labeller= labeller(Variable = c(
                     `supervision_risk_score_first` = "Supervision Risk Score",
                     `percent_days_employed` = "Percent Days Employed",
                     `jobs_per_year` = "Jobs Per Year",
                     `avg_days_per_drugtest` = "Avg Days Per Drugtest",
                     `drugtests_thc_positive` = "Drugtests_THC_Positive",
                     `drugtests_meth_positive` = "Drugtests_Meth_Positive",
                     `drugtests_cocaine_positive`= "Drugtests_Cocaine_Positive"))) +
      scale_fill_manual(values = palette2) +
      labs(x="Recidivism_within_3years", y="Value", 
           title = "Feature Associations with the Likelihood of Recidivism",
           subtitle = "Numeric features") +
      theme(legend.position = "none") +
    theme(plot.subtitle = element_text(size = 12,face = "italic"),
        plot.title = element_text(size = 18, face = "bold"), 
        axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10), 
        axis.title=element_text(size=9), 
        panel.background = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA, linewidth =0.8))
```





```{r cache = TRUE, warning = FALSE, message = FALSE, fig.height=10}
numeric_var %>%
    gather(Variable, value, -recidivism_within_3years) %>%
    ggplot() + 
    geom_density(aes(value, color=recidivism_within_3years), fill = "transparent") + 
   facet_wrap(~Variable, scales = "free", ncol = 4, labeller= labeller(Variable = c(
                     `residence_puma` = "Residence PUMA",
                     `supervision_risk_score_first` = "Supervision Risk Score",
                     `percent_days_employed` = "Percent Days Employed",
                     `jobs_per_year` = "Jobs Per Year",
                     `avg_days_per_drugtest` = "Avg Days Per Drugtest",
                     `drugtests_thc_positive` = "Drugtests_THC_Positive",
                     `drugtests_meth_positive` = "Drugtests_Meth_Positive",
                     `drugtests_cocaine_positive`= "Drugtests_Cocaine_Positive"))) +
  scale_color_manual(values = palette2) +
    labs(title = "Feature Distributions Based on Recidivism",
         subtitle = "Continous features") +
  theme(plot.subtitle = element_text(size = 12,face = "italic"),
        plot.title = element_text(size = 18, face = "bold"), 
        axis.text.x=element_text(size=9),
        axis.text.y=element_text(size=9), 
        axis.title=element_text(size=9), 
        panel.background = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA, linewidth =0.8))
```





```{r}
numeric_var <- recidivism %>%
  select(recidivism_within_3years, supervision_risk_score_first, percent_days_employed,
         jobs_per_year, avg_days_per_drugtest, drugtests_thc_positive,
         drugtests_meth_positive, drugtests_cocaine_positive) %>%
  na.omit()

# Define ANOVA variables and corresponding new readable names
anova_var <- c("supervision_risk_score_first", "percent_days_employed", "jobs_per_year",
               "avg_days_per_drugtest", "drugtests_thc_positive", "drugtests_meth_positive",
               "drugtests_cocaine_positive")

new_names <- c("Supervision Risk Score", "Percent Days Employed", "Jobs Per Year",
               "Avg Days Per Drugtest", "THC Positive Drugtests", "Meth Positive Drugtests",
               "Cocaine Positive Drugtests")

# Initialize the results data frame
anova_results <- data.frame(
  Variable = new_names,  # use new_names for the variable labels
  Df = integer(length(anova_var)),
  Sum_Sq = numeric(length(anova_var)),
  Mean_Sq = numeric(length(anova_var)),
  F_value = numeric(length(anova_var)),
  P_Value = numeric(length(anova_var)),
  stringsAsFactors = FALSE
)

# Run ANOVA for each variable
for (i in seq_along(anova_var)) {
  var <- anova_var[i]
  
  # Perform ANOVA
  anova_result <- aov(reformulate('recidivism_within_3years', response = var), data = numeric_var)
  
  # Extract the summary
  summary_data <- summary(anova_result)[[1]]
  
  # Fill the results data frame
  anova_results[i, "Df"] <- summary_data["Df"][1]
  anova_results[i, "Sum_Sq"] <- summary_data["Sum Sq"][1]
  anova_results[i, "Mean_Sq"] <- summary_data["Mean Sq"][1]
  anova_results[i, "F_value"] <- summary_data["F value"][1]
  anova_results[i, "P_Value"] <- summary_data["Pr(>F)"][1]
}

# Output the results
anova_results %>%
  kable(col.names = c("Variable", "Degrees of Freedom", "Sum Sq", "Mean Sq", "F value", "P-Value")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  footnote(general_title = "\n", general = "Table 2: ANOVA Results for Numeric Variables")
```


## Feature Engineering
```{r cache = TRUE, warning = FALSE, message = FALSE,fig.width=10, fig.height=10}
# age
recidivism <-recidivism %>%
  mutate(age = case_when(
    age_at_release == "18-22"  ~ "Gen Z",
    age_at_release =="38-42" |age_at_release == "43-47" |age_at_release == "48 or older"  ~ "Gen X",
    age_at_release == "23-27" |age_at_release == "28-32" |age_at_release == "33-37" ~ "Millenials"))

recidivism <-recidivism %>%
  mutate(jobnumber = cut(jobs_per_year,
                        breaks = c(-Inf, 1, 5, Inf),  # Define intervals, including all numbers
                        labels = c("0-1", "2-5", "6-8"),  # Labels for each interval
                        include.lowest = TRUE) )

recidivism <-recidivism %>%
  mutate(employmentstates = cut(percent_days_employed,
                        breaks = c(-Inf, 0, 0.99, Inf),  # Define intervals, including all numbers
                        labels = c("Unemployed", "Parttime emplyed", "Employed"),  # Labels for each interval
                        include.lowest = TRUE) )

```






## Logistic Regression
```{r}
set.seed(479)
trainIndex <- createDataPartition(y = paste(recidivism$race) , p = .65,
                                  list = FALSE,
                                  times = 1)
```


```{r}
recidivismTrain <- recidivism[ trainIndex,]
recidivismTest  <- recidivism[-trainIndex,]

recidivismModel <- glm(recidivism_within_3years_numreic ~ .,
                  data=recidivismTrain %>% 
                    dplyr::select(recidivism_within_3years_numreic,gender,race,age_at_release,dependents, supervision_level_first,education_level,prison_years,prison_offense,violations,supervision_risk_score_first, percent_days_employed,jobs_per_year,drugtests_thc_positive,drugtests_cocaine_positive, drugtests_meth_positive,gang_affiliated,prior_arrest_episodes_felony,prior_arrest_episodes_misd,prior_arrest_episodes_property,prior_conviction_episodes_6,prior_conviction_episodes_5,prior_conviction_episodes_4,prior_conviction_episodes_3,prior_conviction_episodes_2,prior_conviction_episodes_1,prior_revocations_probation,prior_revocations_parole,delinquency_reports,residence_changes,violations_instruction), family="binomial" (link="logit"))

recidivism_sum <- summary(recidivismModel)
coefficients_table <- as.data.frame(recidivism_sum$coefficients)

coefficients_table$significance <- ifelse(coefficients_table$`Pr(>|z|)` < 0.001, '***',
                                         ifelse(coefficients_table$`Pr(>|z|)` < 0.01, '**',
                                                ifelse(coefficients_table$`Pr(>|z|)` < 0.05, '*',
                                                       ifelse(coefficients_table$`Pr(>|z|)` < 0.1, '.', ''))))

coefficients_table$p_value <- paste0(round(coefficients_table$`Pr(>|z|)`, digits = 3), coefficients_table$significance)

coefficients_table %>%
  select(-significance, -`Pr(>|z|)`) %>% 
  kable(align = "r") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  footnote(general_title = "\n", general = "Table 3")
```

```{r}
pR2(recidivismModel) #McFadden: 0.246
```

```{r}
testProbs <- data.frame(Outcome = as.factor(recidivismTest$recidivism_within_3years_numreic), Probs = predict(recidivismModel, recidivismTest, type= "response"))
head(testProbs)
```

```{r}
ggplot(testProbs, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density() +
  facet_grid(Outcome ~ .) +
  scale_fill_manual(values = palette2) + xlim(0, 1) +
  labs(x = "Recidivism", y = "Density of probabilities",
       title = "Distribution of predicted probabilities by observed outcome") + theme(strip.text.x = element_text(size = 18),
        legend.position = "none")
```
## ROC Curve
```{r}
ggplot(testProbs, aes(d = as.numeric(testProbs$Outcome), m = Probs)) +
  geom_roc(n.cuts = 50, labels = FALSE, colour = "#FE9900") +
  style_roc(theme = theme_grey) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = 'grey') +
  labs(title = "Figure 5: ROC Curve - Recidivism")
```

```{r}
pROC::auc(testProbs$Outcome, testProbs$Probs) # AUC: .73
```


```{r}
testProbs <- 
  testProbs %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs$Probs > 0.3 , 1, 0)))

caret::confusionMatrix(testProbs$predOutcome, testProbs$Outcome, 
                       positive = "1")
```




## Cross Validation （有问题！）

```{r}
ctrl <- trainControl(method = "cv", number = 100, classProbs=TRUE, summaryFunction=twoClassSummary)

cvFit <- train(recidivism_within_3years_numreic~ .,
                  data=recidivism %>% 
                    dplyr::select(recidivism_within_3years_numreic,gender,race,age_at_release,dependents, supervision_level_first,education_level,prison_years,prison_offense,violations,supervision_risk_score_first, percent_days_employed,jobs_per_year,drugtests_thc_positive,drugtests_cocaine_positive, drugtests_meth_positive,gang_affiliated,prior_arrest_episodes_felony,prior_arrest_episodes_misd,prior_arrest_episodes_property,prior_conviction_episodes_6,prior_conviction_episodes_5,prior_conviction_episodes_4,prior_conviction_episodes_3,prior_conviction_episodes_2,prior_conviction_episodes_1,prior_revocations_probation,prior_revocations_parole,delinquency_reports,residence_changes,violations_instruction), 
                method="glm", family="binomial",
                metric="ROC", trControl = ctrl)

cvFit
```


```{r}
dplyr::select(cvFit$resample, -Resample) %>%
  gather(metric, value) %>%
  left_join(gather(cvFit$results[2:4], metric, mean)) %>%
  ggplot(aes(value)) + 
    geom_histogram(bins=35, fill = "#FF006A") +
    facet_wrap(~metric) +
    geom_vline(aes(xintercept = mean), colour = "#981FAC", linetype = 3, size = 1.5) +
    scale_x_continuous(limits = c(0, 1)) +
    labs(x="Goodness of Fit", y="Count", title="CV Goodness of Fit Metrics",
         subtitle = "Across-fold mean reprented as dotted lines")

```

# Generalizability

## Racial Fairness

```{r}
recidivism %>%
    group_by(recidivism_within_3years, race) %>%
    summarize(n = n()) %>%
    mutate(freq = n / sum(n)) %>% filter(recidivism_within_3years == "true") %>%
    ggplot(aes(reorder(race, -freq), freq)) +
    geom_bar(stat = "identity", position = "dodge", fill = palette2) +
    labs(title = "Recidivism rate by race",
         y = "Rate", x = "Race") +
    theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



```{r}
reg.noRace <- glm(recidivism_within_3years_numreic ~ ., data = 
                    recidivismTrain %>% dplyr::select(recidivism_within_3years_numreic,gender,age_at_release,dependents, supervision_level_first,education_level,prison_years,prison_offense,violations,supervision_risk_score_first, percent_days_employed,jobs_per_year,drugtests_thc_positive,drugtests_cocaine_positive, drugtests_meth_positive,gang_affiliated,prior_arrest_episodes_felony,prior_arrest_episodes_misd,prior_arrest_episodes_property,prior_conviction_episodes_6,prior_conviction_episodes_5,prior_conviction_episodes_4,prior_conviction_episodes_3,prior_conviction_episodes_2,prior_conviction_episodes_1,prior_revocations_probation,prior_revocations_parole,delinquency_reports,residence_changes,violations_instruction),
                family = "binomial"(link = "logit"))

reg.withRace <- glm(recidivism_within_3years_numreic ~ ., data = 
                      recidivismTrain %>% dplyr::select(recidivism_within_3years_numreic,gender,race,age_at_release,dependents, supervision_level_first,education_level,prison_years,prison_offense,violations,supervision_risk_score_first, percent_days_employed,jobs_per_year,drugtests_thc_positive,drugtests_cocaine_positive, drugtests_meth_positive,gang_affiliated,prior_arrest_episodes_felony,prior_arrest_episodes_misd,prior_arrest_episodes_property,prior_conviction_episodes_6,prior_conviction_episodes_5,prior_conviction_episodes_4,prior_conviction_episodes_3,prior_conviction_episodes_2,prior_conviction_episodes_1,prior_revocations_probation,prior_revocations_parole,delinquency_reports,residence_changes,violations_instruction),
                family = "binomial"(link = "logit"))

```


```{r}
testProbs_race <- 
  data.frame(class = recidivismTest$recidivism_within_3years_numreic,
             probs = predict(reg.noRace, recidivismTest, type = "response"),
             Race = recidivismTest$race)
```

```{r}
mutate(testProbs_race, predClass = ifelse(probs >= .5, 1, 0)) %>%
  group_by(Race) %>%
  summarize(Observed.recidivism = sum(class) / n(),
            Predicted.recidivism = sum(predClass) / n()) %>%
  gather(Variable, Value, -Race) %>%
  ggplot(aes(Race, Value)) +
    geom_bar(aes(fill = Race), position="dodge", stat="identity") +
    scale_fill_manual(values = palette2) +
    facet_wrap(~Variable) +
    labs(title = "Observed and predicted recidivism", x = "Race", y = "Rate") +
    theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
iterateThresholds <- function(data, observedClass, predictedProbs, group) {
  observedClass <- enquo(observedClass)
  predictedProbs <- enquo(predictedProbs)
  group <- enquo(group)
  x = .01
  all_prediction <- data.frame()
  
  if (missing(group)) {
  
    while (x <= 1) {
    this_prediction <- data.frame()
    
    this_prediction <-
      data %>%
      mutate(predclass = ifelse(!!predictedProbs > x, 1,0)) %>%
      count(predclass, !!observedClass) %>%
      summarize(Count_TN = sum(n[predclass==0 & !!observedClass==0]),
                Count_TP = sum(n[predclass==1 & !!observedClass==1]),
                Count_FN = sum(n[predclass==0 & !!observedClass==1]),
                Count_FP = sum(n[predclass==1 & !!observedClass==0]),
                Rate_TP = Count_TP / (Count_TP + Count_FN),
                Rate_FP = Count_FP / (Count_FP + Count_TN),
                Rate_FN = Count_FN / (Count_FN + Count_TP),
                Rate_TN = Count_TN / (Count_TN + Count_FP),
                Accuracy = (Count_TP + Count_TN) / 
                           (Count_TP + Count_TN + Count_FN + Count_FP)) %>%
      mutate(Threshold = round(x,2))
    
    all_prediction <- rbind(all_prediction,this_prediction)
    x <- x + .01
  }
  return(all_prediction)
  }
  else if (!missing(group)) { 
   while (x <= 1) {
    this_prediction <- data.frame()
    
    this_prediction <-
      data %>%
      mutate(predclass = ifelse(!!predictedProbs > x, 1,0)) %>%
      group_by(!!group) %>%
      count(predclass, !!observedClass) %>%
      summarize(Count_TN = sum(n[predclass==0 & !!observedClass==0]),
                Count_TP = sum(n[predclass==1 & !!observedClass==1]),
                Count_FN = sum(n[predclass==0 & !!observedClass==1]),
                Count_FP = sum(n[predclass==1 & !!observedClass==0]),
                Rate_TP = Count_TP / (Count_TP + Count_FN),
                Rate_FP = Count_FP / (Count_FP + Count_TN),
                Rate_FN = Count_FN / (Count_FN + Count_TP),
                Rate_TN = Count_TN / (Count_TN + Count_FP),
                Accuracy = (Count_TP + Count_TN) / 
                           (Count_TP + Count_TN + Count_FN + Count_FP)) %>%
      mutate(Threshold = round(x, 2))
    
    all_prediction <- rbind(all_prediction, this_prediction)
    x <- x + .01
  }
  return(all_prediction)
  }
}
```

```{r}
testProbs.thresholds <- 
  iterateThresholds(data=testProbs_race, observedClass = class, 
                    predictedProbs = probs, group = Race)

filter(testProbs.thresholds, Threshold == .5)  %>%
  dplyr::select(Accuracy, Race, starts_with("Rate")) %>%
  gather(Variable, Value, -Race) %>%
    ggplot(aes(Variable, Value, fill = Race)) +
      geom_bar(aes(fill = Race), position = "dodge", stat = "identity") +
      scale_fill_manual(values = palette2) +
      labs(title="Confusion matrix rates by race",
           subtitle = "50% threshold", x = "Outcome",y = "Rate") +
      theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```
```{r}
aucTable <- 
  testProbs_race %>% 
  group_by(Race) %>% 
  summarize(AUC = auc(class,probs)) %>% 
  mutate(AUC = as.character(round(AUC, 2)))

mutate(testProbs_race.thresholds, pointSize = ifelse(Threshold == .48, 24, 16)) %>%
  ggplot(aes(Rate_FP, Rate_TP, colour=Race)) + 
  geom_point(aes(shape = pointSize)) + geom_line() + scale_shape_identity() +
  scale_color_manual(values = palette2) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = 'grey') +
  annotation_custom(tableGrob(aucTable, rows = NULL), xmin = .65, xmax = 1, ymin = 0, ymax = .25) +
  labs(title="ROC Curves by race", x="False Positive Rate", y="True Positive Rate") +
  plotTheme()
```

## Racial-Gender Fairness (还没改！)

```{r}
recidivism %>%
    group_by(recidivism_within_3years, race) %>%
    summarize(n = n()) %>%
    mutate(freq = n / sum(n)) %>% filter(recidivism_within_3years == "true") %>%
    ggplot(aes(reorder(race, -freq), freq)) +
    geom_bar(stat = "identity", position = "dodge", fill = palette2) +
    labs(title = "Recidivism rate by race",
         y = "Rate", x = "Race") +
    theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



```{r}
reg.noRace <- glm(recidivism_within_3years_numreic ~ ., data = 
                    recidivismTrain %>% dplyr::select(recidivism_within_3years_numreic,gender,age_at_release,dependents, supervision_level_first,education_level,prison_years,violations,supervision_risk_score_first, percent_days_employed,jobs_per_year,drugtests_thc_positive, drugtests_meth_positive,gang_affiliated,prior_arrest_episodes_felony,prior_arrest_episodes_misd,prior_arrest_episodes_property),
                family = "binomial"(link = "logit"))

reg.withRace <- glm(recidivism_within_3years_numreic ~ ., data = 
                      recidivismTrain %>% dplyr::select(recidivism_within_3years_numreic,gender,race,age_at_release,dependents, supervision_level_first,education_level,prison_years,violations,supervision_risk_score_first, percent_days_employed,jobs_per_year,drugtests_thc_positive, drugtests_meth_positive,gang_affiliated,prior_arrest_episodes_felony,prior_arrest_episodes_misd,prior_arrest_episodes_property),
                family = "binomial"(link = "logit"))

```

```{r}
testProbs_race_gender <- 
  data.frame(class = recidivismTest$recidivism_within_3years_numreic,
             probs = predict(reg.noRace, recidivismTest, type = "response"),
             Race = recidivismTest$race)
```

```{r}
mutate(testProbs_race_gender, predClass = ifelse(probs >= .5, 1, 0)) %>%
  group_by(Race) %>%
  summarize(Observed.recidivism = sum(class) / n(),
            Predicted.recidivism = sum(predClass) / n()) %>%
  gather(Variable, Value, -Race) %>%
  ggplot(aes(Race, Value)) +
    geom_bar(aes(fill = Race), position="dodge", stat="identity") +
    scale_fill_manual(values = palette2) +
    facet_wrap(~Variable) +
    labs(title = "Observed and predicted recidivism", x = "Race", y = "Rate") +
    theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
iterateThresholds <- function(data, observedClass, predictedProbs, group) {
  observedClass <- enquo(observedClass)
  predictedProbs <- enquo(predictedProbs)
  group <- enquo(group)
  x = .01
  all_prediction <- data.frame()
  
  if (missing(group)) {
  
    while (x <= 1) {
    this_prediction <- data.frame()
    
    this_prediction <-
      data %>%
      mutate(predclass = ifelse(!!predictedProbs > x, 1,0)) %>%
      count(predclass, !!observedClass) %>%
      summarize(Count_TN = sum(n[predclass==0 & !!observedClass==0]),
                Count_TP = sum(n[predclass==1 & !!observedClass==1]),
                Count_FN = sum(n[predclass==0 & !!observedClass==1]),
                Count_FP = sum(n[predclass==1 & !!observedClass==0]),
                Rate_TP = Count_TP / (Count_TP + Count_FN),
                Rate_FP = Count_FP / (Count_FP + Count_TN),
                Rate_FN = Count_FN / (Count_FN + Count_TP),
                Rate_TN = Count_TN / (Count_TN + Count_FP),
                Accuracy = (Count_TP + Count_TN) / 
                           (Count_TP + Count_TN + Count_FN + Count_FP)) %>%
      mutate(Threshold = round(x,2))
    
    all_prediction <- rbind(all_prediction,this_prediction)
    x <- x + .01
  }
  return(all_prediction)
  }
  else if (!missing(group)) { 
   while (x <= 1) {
    this_prediction <- data.frame()
    
    this_prediction <-
      data %>%
      mutate(predclass = ifelse(!!predictedProbs > x, 1,0)) %>%
      group_by(!!group) %>%
      count(predclass, !!observedClass) %>%
      summarize(Count_TN = sum(n[predclass==0 & !!observedClass==0]),
                Count_TP = sum(n[predclass==1 & !!observedClass==1]),
                Count_FN = sum(n[predclass==0 & !!observedClass==1]),
                Count_FP = sum(n[predclass==1 & !!observedClass==0]),
                Rate_TP = Count_TP / (Count_TP + Count_FN),
                Rate_FP = Count_FP / (Count_FP + Count_TN),
                Rate_FN = Count_FN / (Count_FN + Count_TP),
                Rate_TN = Count_TN / (Count_TN + Count_FP),
                Accuracy = (Count_TP + Count_TN) / 
                           (Count_TP + Count_TN + Count_FN + Count_FP)) %>%
      mutate(Threshold = round(x, 2))
    
    all_prediction <- rbind(all_prediction, this_prediction)
    x <- x + .01
  }
  return(all_prediction)
  }
}
```

```{r}
testProbs.thresholds <- 
  iterateThresholds(data=testProbs_race_gender, observedClass = class, 
                    predictedProbs = probs, group = Race)

filter(testProbs.thresholds, Threshold == .5)  %>%
  dplyr::select(Accuracy, Race, starts_with("Rate")) %>%
  gather(Variable, Value, -Race) %>%
    ggplot(aes(Variable, Value, fill = Race)) +
      geom_bar(aes(fill = Race), position = "dodge", stat = "identity") +
      scale_fill_manual(values = palette2) +
      labs(title="Confusion matrix rates by race",
           subtitle = "50% threshold", x = "Outcome",y = "Rate") +
      theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```


#  Cost-Benefit Analysis （差不多了！）

```{r}
cost_benefit_table <-
   testProbs %>%
      count(predOutcome, Outcome) %>%
      summarize(True_Negative = sum(n[predOutcome==0 & Outcome==0]),
                True_Positive = sum(n[predOutcome==1 & Outcome==1]),
                False_Negative = sum(n[predOutcome==0 & Outcome==1]),
                False_Positive = sum(n[predOutcome==1 & Outcome==0])) %>%
       gather(Variable, Count) %>%
       mutate(Revenue =
               ifelse(Variable == "True_Negative", Count * 0,
               ifelse(Variable == "True_Positive",((.35 - .1) * Count),
               ifelse(Variable == "False_Negative", (-0.35) * Count,
               ifelse(Variable == "False_Positive", (-0.1) * Count, 0))))) %>%
    bind_cols(data.frame(Description = c(
              "We correctly predicted no recidivism",
              "We correctly predicted a recidivism",
              "We predicted no recidivism but the crimer recidivate",
              "We predicted a recidivism but the crimer did not recidivate")))

kable(cost_benefit_table,
       caption = "Cost/Benefit Table") %>% kable_styling()
```

```{r}
iterateThresholds <- function(data) {
  x = .01
  all_prediction <- data.frame()
  while (x <= 1) {
  
  this_prediction <-
      testProbs %>%
      mutate(predOutcome = ifelse(Probs > x, 1, 0)) %>%
      count(predOutcome, Outcome) %>%
      summarize(True_Negative = sum(n[predOutcome==0 & Outcome==0]),
                True_Positive = sum(n[predOutcome==1 & Outcome==1]),
                False_Negative = sum(n[predOutcome==0 & Outcome==1]),
                False_Positive = sum(n[predOutcome==1 & Outcome==0])) %>%
     gather(Variable, Count) %>%
     mutate(Revenue =
               ifelse(Variable == "True_Negative", Count * 0,
               ifelse(Variable == "True_Positive",((.35 - .1) * Count),
               ifelse(Variable == "False_Negative", (-0.35) * Count,
               ifelse(Variable == "False_Positive", (-0.1) * Count, 0)))),
            Threshold = x)
  
  all_prediction <- rbind(all_prediction, this_prediction)
  x <- x + .01
  }
return(all_prediction)
}

```

```{r}
whichThreshold <- iterateThresholds(testProbs)

whichThreshold_revenue <- 
whichThreshold %>% 
    group_by(Threshold) %>% 
    summarize(Revenue = sum(Revenue))

whichThreshold %>%
  ggplot(.,aes(Threshold, Revenue, colour = Variable)) +
  geom_point() +
  scale_colour_manual(values = palette5[c(5, 1:3)]) +    
  labs(title = "Figure 9: Revenue by confusion matrix type and threshold",
       y = "Revenue") +
  theme_minimal() +
  guides(colour=guide_legend(title = "Confusion Matrix")) 
```


```{r}

whichThreshold <- iterateThresholds(testProbs2)

whichThreshold_revenue <- 
whichThreshold %>% 
    group_by(Threshold) %>% 
    summarize(Revenue = sum(Revenue))

  ggplot(whichThreshold_revenue)+
    theme_minimal()+
  geom_line(aes(x = Threshold, y = Revenue))+
  geom_vline(xintercept =  pull(arrange(whichThreshold_revenue, -Revenue)[1,1]))+
    labs(title = "Model Revenues By Threshold For Test Sample",
         subtitle = "Vertical Line Denotes Optimal Threshold")
```








